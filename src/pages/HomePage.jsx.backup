import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import { FileText, ArrowRight, Upload, Image as ImageIcon, Loader, Settings, ExternalLink } from 'lucide-react';
import data from '../data.json';
import './HomePage.css';

export function HomePage() {
    const [uploadedImage, setUploadedImage] = useState(null);
    const [isProcessing, setIsProcessing] = useState(false);
    const [processingStatus, setProcessingStatus] = useState('');
    const [showUploadModal, setShowUploadModal] = useState(false);
    const [showSettingsModal, setShowSettingsModal] = useState(false);
    const [apiKey, setApiKey] = useState('');
    const [tempApiKey, setTempApiKey] = useState('');

    // Load API key from localStorage on mount
    React.useEffect(() => {
        const saved = localStorage.getItem('gemini_api_key');
        if (saved) {
            setApiKey(saved);
            setTempApiKey(saved);
        }
    }, []);

    const handleImageUpload = (e) => {
        const file = e.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                setUploadedImage(event.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    const handleDrop = (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
                setUploadedImage(event.target.result);
            };
            reader.readAsDataURL(file);
        }
    };

    const handleDragOver = (e) => {
        e.preventDefault();
    };

    const processImage = async () => {
        if (!uploadedImage) return;

        if (!apiKey) {
            alert('Gemini APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚\nå³ä¸Šã®âš™ï¸ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¨­å®šã§ãã¾ã™ã€‚');
            setShowSettingsModal(true);
            return;
        }

        setIsProcessing(true);
        setProcessingStatus('ç”»åƒã‚’è§£æä¸­...');

        try {
            // Call Gemini API directly from frontend
            const base64Image = uploadedImage.replace(/^data:image\/\w+;base64,/, '');

            const prompt = `ã“ã®ç”»åƒã¯è‹±æ¤œæº–2ç´šã®ä¼šè©±æ–‡ç©ºæ‰€è£œå……å•é¡Œã§ã™ã€‚ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

ã€æŠ½å‡ºã™ã‚‹æƒ…å ±ã€‘
1. **å¹´åº¦ã¨å›** (ä¾‹: "2021å¹´åº¦ ç¬¬2å›")
2. **å•é¡Œç•ªå·** (21-25ã®ç¯„å›²)
3. **ä¼šè©±æ–‡å…¨ä½“** (A:ã¨B:ã®ç™ºè¨€ã‚’æ­£ç¢ºã«)
4. **4ã¤ã®é¸æŠè‚¢** (1-4ã®ç•ªå·ä»˜ã)
5. **æ­£è§£ç•ªå·** (1-4)

ã€å„å•é¡Œã«ã¤ã„ã¦ã€ä»¥ä¸‹ã®å……å®Ÿã—ãŸè§£èª¬ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‘:
- ã€ä¼šè©±ã®çŠ¶æ³ã€‘: ãã®ä¼šè©±ãŒã©ã®ã‚ˆã†ãªå ´é¢ã§è¡Œã‚ã‚Œã¦ã„ã‚‹ã‹
- ã€é‡è¦èªå½™ã€‘: å•é¡Œæ–‡ã«å‡ºã¦ãã‚‹é‡è¦ãªè‹±å˜èªãƒ»è¡¨ç¾ã®æ„å‘³ï¼ˆ3-5å€‹ï¼‰
- ã€é¸æŠè‚¢ã®æ¤œè¨ã€‘: å„é¸æŠè‚¢ã«ã¤ã„ã¦ã€ãªãœæ­£è§£/ä¸æ­£è§£ãªã®ã‹ã‚’è©³ã—ãèª¬æ˜
- ã€æ­£è§£ã®æ ¹æ‹ ã€‘: ä¼šè©±ã®ã©ã®éƒ¨åˆ†ã‹ã‚‰æ­£è§£ãŒå°ã‘ã‚‹ã‹ã€å…·ä½“çš„ãªæ ¹æ‹ 
- ã€æ–‡æ³•ãƒ»è¡¨ç¾ã®ãƒã‚¤ãƒ³ãƒˆã€‘: é‡è¦ãªæ–‡æ³•äº‹é …ã‚„è¡¨ç¾ã®è§£èª¬ï¼ˆè©²å½“ã™ã‚‹å ´åˆï¼‰

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰:
{
  "year": "å¹´åº¦",
  "session": "ç¬¬Xå›",
  "questions": [
    {
      "number": 21,
      "correctAnswer": 2,
      "conversation": [
        {"speaker": "A", "text": "..."},
        {"speaker": "B", "text": "... ( 21 ) ..."}
      ],
      "choices": [
        {"index": 1, "text": "..."},
        {"index": 2, "text": "..."},
        {"index": 3, "text": "..."},
        {"index": 4, "text": "..."}
      ],
      "explanation": "ã€ä¼šè©±ã®çŠ¶æ³ã€‘\\n...\\n\\nã€é‡è¦èªå½™ã€‘\\n...\\n\\nã€é¸æŠè‚¢ã®æ¤œè¨ã€‘\\n...\\n\\nã€æ­£è§£ã®æ ¹æ‹ ã€‘\\n...\\n\\nã€æ–‡æ³•ãƒ»è¡¨ç¾ã®ãƒã‚¤ãƒ³ãƒˆã€‘\\n..."
    }
  ]
}

ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãªã—ã§ã€ç´”ç²‹ãªJSONã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: 'image/jpeg',
                                    data: base64Image
                                }
                            }
                        ]
                    }]
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error?.message || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            setProcessingStatus('å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...');
            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;

            // Parse JSON from response
            let examData;
            try {
                examData = JSON.parse(text);
            } catch {
                const jsonMatch = text.match(/```(?:json)?\s*(\{[\s\S]*\})\s*```/);
                if (jsonMatch) {
                    examData = JSON.parse(jsonMatch[1]);
                } else {
                    throw new Error('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            setProcessingStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ä¸­...');

            // Transform and save to localStorage (will need page reload to update)
            const newItem = transformExamData(examData);
            const existingData = JSON.parse(localStorage.getItem('exam_data') || '[]');

            // Remove duplicates and add to beginning
            const filteredData = existingData.filter(d => d.filename !== newItem.filename);
            filteredData.unshift(newItem);

            localStorage.setItem('exam_data', JSON.stringify(filteredData));

            setProcessingStatus('å®Œäº†ï¼ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¾ã™...');
            setTimeout(() => {
                window.location.reload();
            }, 1500);

        } catch (error) {
            console.error('Error:', error);
            setProcessingStatus('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            setIsProcessing(false);
        }
    };

    const transformExamData = (examData) => {
        const newItem = {
            filename: `manual_${examData.year.replace(/å¹´åº¦/, '')}_${examData.session.replace(/ç¬¬|å›/g, '')}`,
            title: `${examData.year} ${examData.session} è‹±æ¤œæº–2ç´š`,
            passage: `Manual entry for ${examData.year} ${examData.session}`,
            questions: examData.questions.map(q => ({
                number: q.number,
                correctAnswer: q.correctAnswer,
                choices: q.choices,
                explanation: q.explanation
            })),
            sentences: []
        };

        let sentenceId = parseInt(`${examData.year.match(/\d+/)[0]}${examData.session.match(/\d+/)[0]}`) * 100000;

        examData.questions.forEach(q => {
            q.conversation.forEach((line, idx) => {
                newItem.sentences.push({
                    id: sentenceId++,
                    english: `${line.speaker}: ${line.text}`,
                    japanese: "",
                    notes: idx === 1 ? q.explanation : "",
                    relatedQ: q.number
                });
            });

            q.choices.forEach(choice => {
                newItem.sentences.push({
                    id: sentenceId++,
                    english: `${choice.index}. ${choice.text}`,
                    japanese: "",
                    notes: "",
                    relatedQ: q.number
                });
            });
        });

        return newItem;
    };

    // Handle paste event for clipboard screenshots
    const handlePaste = (e) => {
        const items = e.clipboardData?.items;
        if (!items) return;

        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    setUploadedImage(event.target.result);
                };
                reader.readAsDataURL(blob);
                break;
            }
        }
    };

    // Add paste event listener when modal is open
    React.useEffect(() => {
        if (showUploadModal && !uploadedImage) {
            window.addEventListener('paste', handlePaste);
            return () => {
                window.removeEventListener('paste', handlePaste);
            };
        }
    }, [showUploadModal, uploadedImage]);

    return (
        <div className="home-page">
            <div className="hero-section">
                <h1>è‹±æ¤œæº–2ç´š é•·æ–‡ç©ºæ‰€è£œå……å•é¡Œ</h1>
                <p>å•é¡Œã‚’é¸æŠã—ã¦å­¦ç¿’ã‚’é–‹å§‹ã™ã‚‹ã‹ã€æ–°ã—ã„å•é¡Œã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>

                <button
                    className="btn btn-upload-trigger"
                    onClick={() => setShowUploadModal(true)}
                >
                    <Upload size={20} />
                    æ–°ã—ã„å•é¡Œã‚’è¿½åŠ ï¼ˆç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
                </button>
            </div>

            {/* Upload Modal */}
            {showUploadModal && (
                <div className="modal-overlay" onClick={() => !isProcessing && setShowUploadModal(false)}>
                    <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                        <div className="modal-header">
                            <h2>å•é¡Œç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
                            <button
                                className="modal-close"
                                onClick={() => !isProcessing && setShowUploadModal(false)}
                                disabled={isProcessing}
                            >Ã—</button>
                        </div>

                        <div className="modal-body">
                            {!uploadedImage ? (
                                <div
                                    className="upload-area"
                                    onDrop={handleDrop}
                                    onDragOver={handleDragOver}
                                >
                                    <ImageIcon size={48} className="upload-icon" />
                                    <p className="upload-text">
                                        ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br />
                                        ã¾ãŸã¯
                                    </p>
                                    <label className="btn btn-primary upload-label">
                                        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                                        <input
                                            type="file"
                                            accept="image/*"
                                            onChange={handleImageUpload}
                                            style={{ display: 'none' }}
                                        />
                                    </label>
                                    <p className="upload-hint">
                                        è‹±æ¤œå•é¡Œã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„<br />
                                        <span style={{ fontSize: '0.9em', color: '#10b981', fontWeight: '600' }}>
                                            ğŸ’¡ Ctrl+V ã§ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰è²¼ã‚Šä»˜ã‘ã‚‚ã§ãã¾ã™
                                        </span>
                                    </p>
                                </div>
                            ) : (
                                <div className="image-preview-area">
                                    <img
                                        src={uploadedImage}
                                        alt="Uploaded exam"
                                        className="preview-image"
                                    />

                                    {!isProcessing ? (
                                        <div className="preview-actions">
                                            <button
                                                className="btn btn-secondary"
                                                onClick={() => setUploadedImage(null)}
                                            >
                                                ç”»åƒã‚’å¤‰æ›´
                                            </button>
                                            <button
                                                className="btn btn-success"
                                                onClick={processImage}
                                            >
                                                å•é¡Œã‚’è§£æãƒ»ç™»éŒ²
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="processing-status">
                                            <Loader className="spinner" size={32} />
                                            <p>{processingStatus}</p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            <div className="passage-grid">
                {data.map((item, index) => {
                    const displayTitle = item.title || item.filename.replace('.txt', '');
                    const passagePreview = item.passage.substring(0, 150) + '...';

                    return (
                        <div key={index} className="card passage-card">
                            <div className="card-header">
                                <FileText className="card-icon" size={24} />
                                <h2 className="card-title">{displayTitle}</h2>
                            </div>

                            <p className="card-preview">{passagePreview}</p>

                            <div className="card-footer">
                                <div className="question-count">
                                    {item.questions.length} Questions
                                </div>
                                <Link to={`/quiz/${index}`} className="btn btn-primary">
                                    Start Practice
                                    <ArrowRight size={16} />
                                </Link>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}
